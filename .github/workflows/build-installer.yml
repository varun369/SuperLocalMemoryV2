# SuperLocalMemory V2 - Windows Installer Build Workflow
# Copyright (c) 2026 Varun Pratap Bhardwaj
# Licensed under MIT License
# Repository: https://github.com/varun369/SuperLocalMemoryV2

name: Build Windows Installer

on:
  push:
    tags:
      - 'v*-installer'
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 2.1.0)'
        required: true
        default: '2.3.0'

permissions:
  contents: write

jobs:
  build-windows-installer:
    name: Build Windows EXE Installer
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Inno Setup
        run: |
          choco install innosetup -y --version=6.2.2
          echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Inno Setup installation
        run: |
          $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $iscc) {
            Write-Host "✓ Inno Setup found at: $iscc"
            & $iscc /? 2>&1 | Select-Object -First 3
          } else {
            Write-Error "✗ Inno Setup not found"
            exit 1
          }

      - name: Create assets directory
        run: |
          New-Item -ItemType Directory -Path assets -Force
          Write-Host "✓ Assets directory created"

      - name: Create placeholder icon
        run: |
          # Create minimal ICO file (placeholder)
          # In production, replace with actual icon
          $iconPath = "assets\icon.ico"
          if (-not (Test-Path $iconPath)) {
            Write-Warning "Icon not found, using default Windows icon"
          }

      - name: Pre-build validation
        run: |
          Write-Host "Validating build requirements..."

          # Check required files
          $requiredFiles = @(
            "installer.iss",
            "install.ps1",
            "src/memory_store_v2.py",
            "mcp_server.py",
            "LICENSE",
            "README.md"
          )

          $allValid = $true
          foreach ($file in $requiredFiles) {
            if (Test-Path $file) {
              Write-Host "✓ Found: $file"
            } else {
              Write-Error "✗ Missing: $file"
              $allValid = $false
            }
          }

          if (-not $allValid) {
            Write-Error "Pre-build validation failed"
            exit 1
          }

          Write-Host "`n✓ All required files present"

      - name: Build installer
        run: |
          Write-Host "Building Windows installer..."
          .\build-exe.ps1 -Method innosetup -SkipTests

      - name: Verify build output
        run: |
          $exePath = "dist\SuperLocalMemory-Setup-v2.3.0-windows.exe"
          if (Test-Path $exePath) {
            $fileSize = (Get-Item $exePath).Length / 1MB
            Write-Host "✓ Installer created: $exePath"
            Write-Host "  Size: $([math]::Round($fileSize, 2)) MB"
          } else {
            Write-Error "✗ Installer not found: $exePath"
            exit 1
          }

      - name: Calculate checksums
        run: |
          Write-Host "Generating checksums..."
          $exePath = "dist\SuperLocalMemory-Setup-v2.3.0-windows.exe"

          # SHA256
          $sha256 = Get-FileHash -Path $exePath -Algorithm SHA256
          Set-Content -Path "$exePath.sha256" -Value "$($sha256.Hash)  $(Split-Path -Leaf $exePath)"
          Write-Host "✓ SHA256: $($sha256.Hash)"

          # MD5 (for additional verification)
          $md5 = Get-FileHash -Path $exePath -Algorithm MD5
          Set-Content -Path "$exePath.md5" -Value "$($md5.Hash)  $(Split-Path -Leaf $exePath)"
          Write-Host "✓ MD5: $($md5.Hash)"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/SuperLocalMemory-Setup-*.exe
            dist/SuperLocalMemory-Setup-*.exe.sha256
            dist/SuperLocalMemory-Setup-*.exe.md5
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/SuperLocalMemory-Setup-*.exe
            dist/SuperLocalMemory-Setup-*.exe.sha256
            dist/SuperLocalMemory-Setup-*.exe.md5
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Windows Installer

            **Download:** `SuperLocalMemory-Setup-v2.3.0-windows.exe`

            ### Installation
            1. Download the installer
            2. Double-click to run
            3. Follow the wizard
            4. Restart terminal
            5. Run `slm status` to verify

            ### System Requirements
            - Windows 10/11 (64-bit)
            - Python 3.8 or higher
            - 100 MB disk space

            ### Checksums
            See `.sha256` and `.md5` files for verification.

            ### Documentation
            - [Installation Guide](https://github.com/varun369/SuperLocalMemoryV2/wiki/Installation)
            - [Quick Start](https://github.com/varun369/SuperLocalMemoryV2/wiki/Quick-Start-Tutorial)
            - [Troubleshooting](https://github.com/varun369/SuperLocalMemoryV2/wiki/Troubleshooting)

            ---

            **Full Changelog:** https://github.com/varun369/SuperLocalMemoryV2/blob/main/CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          Write-Host "`n═══════════════════════════════════════════════════════════"
          Write-Host "  Build Complete!" -ForegroundColor Green
          Write-Host "═══════════════════════════════════════════════════════════"
          Write-Host ""
          Write-Host "Artifacts:"
          Get-ChildItem dist\SuperLocalMemory-Setup-* | ForEach-Object {
            Write-Host "  • $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)"
          }
          Write-Host ""
          Write-Host "Download URL will be available after release is published."
          Write-Host ""

  test-installer:
    name: Test Installer (Optional)
    needs: build-windows-installer
    runs-on: windows-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Download installer
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: dist

      - name: Run installer in silent mode
        run: |
          $installer = Get-ChildItem dist\SuperLocalMemory-Setup-*.exe | Select-Object -First 1
          Write-Host "Testing installer: $($installer.Name)"

          # Silent install
          Start-Process -FilePath $installer.FullName -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/LOG=install.log" -Wait

          Write-Host "✓ Installation completed"

      - name: Verify installation
        run: |
          # Check if slm command works
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","User") + ";" + [System.Environment]::GetEnvironmentVariable("Path","Machine")

          if (Get-Command slm -ErrorAction SilentlyContinue) {
            Write-Host "✓ slm command found"
            & slm --version
          } else {
            Write-Warning "slm command not found in PATH (may need restart)"
          }

          # Check installation directory
          $installDir = "$env:USERPROFILE\.claude-memory"
          if (Test-Path $installDir) {
            Write-Host "✓ Installation directory exists: $installDir"
            $files = Get-ChildItem $installDir -File | Select-Object -First 5
            Write-Host "  Files installed:"
            $files | ForEach-Object { Write-Host "    • $($_.Name)" }
          } else {
            Write-Error "✗ Installation directory not found: $installDir"
          }

      - name: Upload installation log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: installation-log
          path: install.log
          retention-days: 30
