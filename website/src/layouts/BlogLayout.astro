---
import BaseLayout from './BaseLayout.astro';
import Comments from '../components/blog/Comments.astro';
import BreadcrumbSchema from '../components/seo/BreadcrumbSchema.astro';
import { FadeIn } from '../components/ui/Motion';
import { getCollection } from 'astro:content';
import { ArrowRight, Calendar } from 'lucide-react';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  author: string;
  tags: string[];
  category: string;
  image?: string;
  keywords?: string;
}

const { title, description, pubDate, updatedDate, author, tags, category, image, keywords } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const formattedDate = pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
const formattedUpdatedDate = updatedDate?.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

// Fetch related posts: prefer same category, then same tags, exclude current post
const currentSlug = Astro.url.pathname.replace('/blog/', '').replace(/\/$/, '');
const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .filter(p => p.id !== currentSlug)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Score posts by relevance: same category = 3 points, each shared tag = 1 point
const scoredPosts = allPosts.map(post => {
  let score = 0;
  if (post.data.category === category) score += 3;
  score += post.data.tags.filter(t => tags.includes(t)).length;
  return { post, score };
});
scoredPosts.sort((a, b) => b.score - a.score);
const relatedPosts = scoredPosts.slice(0, 3).map(s => s.post);
---

<BaseLayout title={`${title} | SuperLocalMemory`} description={description} ogType="article" keywords={keywords || tags.join(', ')} schemaType="Article">
  <!-- Background Elements -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden">
    <div class="absolute -top-[20%] -right-[10%] w-[800px] h-[800px] rounded-full bg-[var(--color-primary)]/5 blur-[120px]"></div>
    <div class="absolute top-[40%] -left-[10%] w-[600px] h-[600px] rounded-full bg-blue-500/5 blur-[100px]"></div>
  </div>

  <!-- Reading Progress Bar -->
  <div id="reading-progress" class="fixed top-0 left-0 h-1 bg-gradient-to-r from-[var(--color-primary)] to-purple-500 z-[100] w-0 transition-all duration-100 ease-out"></div>

  <Fragment slot="head">
    <meta property="article:published_time" content={pubDate.toISOString()} />
    {updatedDate && <meta property="article:modified_time" content={updatedDate.toISOString()} />}
    <meta property="article:author" content={author} />
    {tags.map(tag => <meta property="article:tag" content={tag} />)}
    {image && <meta property="og:image" content={new URL(image, Astro.site)} />}
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": title,
      "description": description,
      "image": image ? new URL(image, Astro.site).toString() : "https://superlocalmemory.com/assets/social-preview.png",
      "datePublished": pubDate.toISOString(),
      "dateModified": (updatedDate || pubDate).toISOString(),
      "author": {
        "@type": "Person",
        "name": author,
        "url": "https://github.com/varun369"
      },
      "publisher": {
        "@type": "Organization",
        "name": "SuperLocalMemory",
        "url": "https://superlocalmemory.com"
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": canonicalURL.toString()
      }
    })} />
  </Fragment>

  <BreadcrumbSchema items={[
    { name: 'Home', url: 'https://superlocalmemory.com' },
    { name: 'Blog', url: 'https://superlocalmemory.com/blog' },
    { name: title, url: canonicalURL.toString() }
  ]} />

  <article class="relative pt-32 pb-24">
    <div class="container-custom max-w-4xl">
      <!-- Header -->
      <header class="text-center mb-16">
        <FadeIn client:visible>
            <div class="flex items-center justify-center gap-3 mb-6">
                <span class="px-3 py-1 rounded-full text-xs font-bold bg-[var(--color-primary)]/10 text-[var(--color-primary)] border border-[var(--color-primary)]/20 uppercase tracking-wide">
                    {category}
                </span>
                <span class="text-sm text-[var(--color-text-muted)] border-l border-white/10 pl-3">
                    {formattedDate}
                </span>
            </div>

            <h1 class="text-4xl md:text-5xl lg:text-6xl font-black text-white leading-tight mb-6 tracking-tight text-balance">
                {title}
            </h1>

            <p class="text-xl text-[var(--color-text-muted)] max-w-2xl mx-auto mb-8 leading-relaxed text-balance">
                {description}
            </p>

            <div class="flex items-center justify-center gap-4">
                <div class="flex items-center gap-3 bg-white/5 pr-4 pl-1 py-1 rounded-full border border-white/10">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[var(--color-primary)] to-purple-600 flex items-center justify-center text-xs font-bold text-white">
                        {author.charAt(0)}
                    </div>
                    <span class="text-sm font-medium text-white">{author}</span>
                </div>
            </div>
        </FadeIn>
      </header>

      <!-- Content -->
      <FadeIn client:visible delay={0.2}>
          <div class="prose prose-lg prose-invert max-w-none mx-auto
            prose-headings:font-bold prose-headings:tracking-tight prose-headings:text-white
            prose-p:text-[var(--color-text-muted)] prose-p:leading-relaxed
            prose-a:text-[var(--color-primary)] prose-a:no-underline hover:prose-a:underline
            prose-strong:text-white prose-code:text-white prose-code:bg-white/10 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none
            prose-pre:bg-black/50 prose-pre:border prose-pre:border-white/10 prose-pre:rounded-xl
            prose-img:rounded-2xl prose-img:border prose-img:border-white/10 prose-img:shadow-2xl
            prose-li:text-[var(--color-text-muted)]
            prose-blockquote:border-l-[var(--color-primary)] prose-blockquote:bg-white/5 prose-blockquote:py-2 prose-blockquote:px-6 prose-blockquote:rounded-r-lg prose-blockquote:not-italic
            prose-hr:border-white/10
          ">
            <slot />
          </div>
      </FadeIn>

      <!-- Footer Tags & Comments -->
      <footer class="mt-16 pt-16 border-t border-white/10">
        <div class="flex flex-wrap gap-2 mb-12 justify-center">
            {tags.map(tag => (
                <span class="px-3 py-1 rounded-lg text-sm bg-white/5 border border-white/10 text-[var(--color-text-muted)]">
                    #{tag}
                </span>
            ))}
        </div>

        <Comments />

        <!-- Related Posts -->
        {relatedPosts.length > 0 && (
          <div class="mt-16 pt-12 border-t border-white/10">
            <h2 class="text-2xl font-bold text-white mb-8 text-center">Related Articles</h2>
            <div class="grid md:grid-cols-3 gap-6">
              {relatedPosts.map(rp => (
                <a href={`/blog/${rp.id}`} class="group rounded-xl bg-white/5 border border-white/10 overflow-hidden hover:border-[var(--color-primary)]/30 transition-all hover:-translate-y-1">
                  {rp.data.image ? (
                    <div class="aspect-video overflow-hidden">
                      <img
                        src={rp.data.image}
                        alt={rp.data.title}
                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                        onerror="this.parentElement.outerHTML='<div class=\'h-2 bg-gradient-to-r from-sky-400/40 via-purple-500/40 to-indigo-400/40\'></div>'"
                      />
                    </div>
                  ) : (
                    <div class="h-2 bg-gradient-to-r from-[var(--color-primary)]/40 via-purple-500/40 to-[var(--color-accent)]/40"></div>
                  )}
                  <div class="p-5">
                    <div class="flex items-center gap-2 text-xs text-[var(--color-text-muted)] mb-3">
                      <Calendar className="w-3 h-3" />
                      <span>{rp.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
                    </div>
                    <h3 class="text-base font-semibold text-white mb-2 group-hover:text-[var(--color-primary)] transition-colors line-clamp-2">
                      {rp.data.title}
                    </h3>
                    <p class="text-sm text-[var(--color-text-muted)] line-clamp-2">
                      {rp.data.description}
                    </p>
                  </div>
                </a>
              ))}
            </div>
          </div>
        )}

        <div class="text-center mt-12">
            <a href="/blog" class="inline-flex items-center justify-center px-6 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-white font-medium transition-all hover:-translate-y-0.5">
                ‚Üê Back to Blog
            </a>
        </div>
      </footer>
    </div>
  </article>

  <!-- Reading Progress Bar Script -->
  <script>
    const progressBar = document.getElementById('reading-progress');
    if (progressBar) {
      const updateProgress = () => {
        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
        progressBar.style.width = `${Math.min(progress, 100)}%`;
      };
      window.addEventListener('scroll', updateProgress, { passive: true });
      updateProgress();
    }
  </script>
</BaseLayout>

