#!/bin/bash
# slm - Universal CLI wrapper for SuperLocalMemory V2
# Simple commands that work in any terminal or script
#
# Copyright (c) 2026 Varun Pratap Bhardwaj
# Licensed under MIT License
#
# This is a CONVENIENCE wrapper. Original commands still work:
#   superlocalmemoryv2:remember, superlocalmemoryv2:recall, etc.

set -e

SLM_DIR="${HOME}/.claude-memory"

# Check if SuperLocalMemory is installed
if [ ! -d "$SLM_DIR" ]; then
    echo "Error: SuperLocalMemory V2 not installed at $SLM_DIR"
    echo "Please run: ./install.sh"
    exit 1
fi

# Main command dispatcher
case "$1" in
    remember|save|store)
        shift
        # Calls existing command - no duplicate logic
        "$SLM_DIR/bin/superlocalmemoryv2:remember" "$@"
        ;;

    recall|search|find)
        shift
        # Calls existing command - no duplicate logic
        "$SLM_DIR/bin/superlocalmemoryv2:recall" "$@"
        ;;

    list|ls)
        shift
        # Convert positional number to --limit flag
        # e.g., "slm list 5" becomes "--limit 5"
        if [ -n "$1" ] && [[ "$1" =~ ^[0-9]+$ ]]; then
            "$SLM_DIR/bin/superlocalmemoryv2:list" --limit "$1"
        else
            "$SLM_DIR/bin/superlocalmemoryv2:list" "$@"
        fi
        ;;

    status|info|stats)
        # Calls existing command - no duplicate logic
        "$SLM_DIR/bin/superlocalmemoryv2:status"
        ;;

    profile)
        shift
        # Calls existing command - no duplicate logic
        "$SLM_DIR/bin/superlocalmemoryv2:profile" "$@"
        ;;

    reset)
        shift
        # Calls existing command - no duplicate logic
        "$SLM_DIR/bin/superlocalmemoryv2:reset" "$@"
        ;;

    ui|dashboard)
        PORT="${2:-8765}"
        echo "Starting SuperLocalMemory Web Dashboard..."
        echo "URL: http://localhost:$PORT"
        echo "API Docs: http://localhost:$PORT/api/docs"
        echo ""
        python3 "$SLM_DIR/ui_server.py" --port "$PORT"
        ;;

    serve|server)
        PORT="${2:-8417}"
        echo "Starting SuperLocalMemory MCP HTTP server..."
        echo "Endpoint: http://localhost:$PORT"
        echo ""
        echo "For ChatGPT/remote access:"
        echo "  1. In another terminal: ngrok http $PORT"
        echo "  2. Copy the HTTPS URL"
        echo "  3. Add to ChatGPT: Settings -> Apps & Connectors -> Developer Mode"
        echo ""
        exec python3 "$SLM_DIR/mcp_server.py" --transport http --port "$PORT"
        ;;

    context)
        # NEW: Get context for current directory/project
        project=$(basename "$PWD")
        "$SLM_DIR/bin/superlocalmemoryv2:recall" "$project" --limit 5
        ;;

    graph)
        shift
        subcommand="$1"
        shift
        case "$subcommand" in
            build)
                python3 "$SLM_DIR/graph_engine.py" build "$@"
                ;;
            stats)
                python3 "$SLM_DIR/graph_engine.py" stats "$@"
                ;;
            *)
                echo "Usage: slm graph {build|stats}"
                exit 1
                ;;
        esac
        ;;

    patterns)
        shift
        subcommand="$1"
        shift
        case "$subcommand" in
            update)
                python3 "$SLM_DIR/pattern_learner.py" update "$@"
                ;;
            list)
                python3 "$SLM_DIR/pattern_learner.py" list "$@"
                ;;
            context)
                python3 "$SLM_DIR/pattern_learner.py" context "$@"
                ;;
            correct)
                # slm patterns correct <id> <new_value>
                pattern_id="$1"
                new_value="$2"
                if [ -z "$pattern_id" ] || [ -z "$new_value" ]; then
                    echo "Usage: slm patterns correct <pattern_id> <new_value>"
                    exit 1
                fi
                python3 -c "
import sys
sys.path.insert(0, '${SLM_DIR}')
sys.path.insert(0, '$(dirname "${SLM_DIR}")/Documents/AGENTIC_Official/SuperLocalMemoryV2-repo/src')
try:
    from learning import get_learning_db
    ldb = get_learning_db()
    if ldb:
        conn = ldb._get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM transferable_patterns WHERE id = ?', (int(sys.argv[1]),))
        p = cursor.fetchone()
        conn.close()
        if p:
            ldb.upsert_transferable_pattern(
                pattern_type=p['pattern_type'], key=p['key'],
                value=sys.argv[2], confidence=1.0,
                evidence_count=p['evidence_count']+1,
                profiles_seen=p['profiles_seen'],
                contradictions=[f\"Corrected from '{p['value']}' to '{sys.argv[2]}'\"],
            )
            print(f\"Pattern '{p['key']}' corrected: '{p['value']}' -> '{sys.argv[2]}'\")
        else:
            print(f'Pattern #{sys.argv[1]} not found')
    else:
        print('Learning database not available')
except ImportError:
    print('Learning features not available')
except Exception as e:
    print(f'Error: {e}')
" "$pattern_id" "$new_value"
                ;;
            *)
                echo "Usage: slm patterns {update|list|context|correct}"
                exit 1
                ;;
        esac
        ;;

    useful)
        shift
        # Mark memory IDs as useful (v2.7 learning feedback)
        if [ -z "$1" ]; then
            echo "Usage: slm useful <memory_id> [memory_id...]"
            echo "  Mark recalled memories as useful to improve future ranking"
            exit 1
        fi
        python3 -c "
import sys
sys.path.insert(0, '${SLM_DIR}')
sys.path.insert(0, '$(dirname \"${SLM_DIR}\")/Documents/AGENTIC_Official/SuperLocalMemoryV2-repo/src')
try:
    from learning.feedback_collector import FeedbackCollector
    fc = FeedbackCollector()
    ids = [int(x) for x in sys.argv[1:]]
    fc.record_cli_useful(ids, query='cli-feedback')
    print(f'Marked {len(ids)} memor{\"y\" if len(ids)==1 else \"ies\"} as useful')
except ImportError:
    print('Learning features not available. Install: pip3 install lightgbm scipy')
except Exception as e:
    print(f'Error: {e}')
" "$@"
        ;;

    learning)
        shift
        subcommand="${1:-status}"
        shift 2>/dev/null || true
        case "$subcommand" in
            status)
                python3 -c "
import sys, json
sys.path.insert(0, '${SLM_DIR}')
sys.path.insert(0, '$(dirname \"${SLM_DIR}\")/Documents/AGENTIC_Official/SuperLocalMemoryV2-repo/src')
try:
    from learning import get_status
    status = get_status()
    print('SuperLocalMemory v2.7 â€” Learning System Status')
    print('=' * 50)
    deps = status['dependencies']
    print(f'LightGBM:  {\"installed (\" + deps[\"lightgbm\"][\"version\"] + \")\" if deps[\"lightgbm\"][\"installed\"] else \"not installed\"}')
    print(f'SciPy:     {\"installed (\" + deps[\"scipy\"][\"version\"] + \")\" if deps[\"scipy\"][\"installed\"] else \"not installed\"}')
    print(f'ML Ranking:  {\"available\" if status[\"ml_ranking_available\"] else \"unavailable\"}')
    print(f'Full Learning: {\"available\" if status[\"learning_available\"] else \"unavailable\"}')
    if status.get('learning_db_stats'):
        s = status['learning_db_stats']
        print(f'')
        print(f'Feedback signals: {s[\"feedback_count\"]}')
        print(f'Unique queries:   {s[\"unique_queries\"]}')
        print(f'Patterns learned: {s[\"transferable_patterns\"]} ({s[\"high_confidence_patterns\"]} high confidence)')
        print(f'Workflow patterns: {s[\"workflow_patterns\"]}')
        print(f'Sources tracked:  {s[\"tracked_sources\"]}')
        print(f'Models trained:   {s[\"models_trained\"]}')
        print(f'Learning DB size: {s[\"db_size_kb\"]} KB')
except ImportError:
    print('Learning features not available. Install: pip3 install lightgbm scipy')
except Exception as e:
    print(f'Error: {e}')
"
                ;;
            retrain)
                python3 -c "
import sys
sys.path.insert(0, '${SLM_DIR}')
sys.path.insert(0, '$(dirname \"${SLM_DIR}\")/Documents/AGENTIC_Official/SuperLocalMemoryV2-repo/src')
try:
    from learning import get_adaptive_ranker
    ranker = get_adaptive_ranker()
    if ranker:
        result = ranker.train(force=True)
        if result:
            print(f'Model retrained successfully')
        else:
            print('Insufficient data for training (need 200+ feedback signals)')
    else:
        print('Adaptive ranker not available')
except ImportError:
    print('Learning features not available. Install: pip3 install lightgbm scipy')
except Exception as e:
    print(f'Error: {e}')
"
                ;;
            reset)
                python3 -c "
import sys
sys.path.insert(0, '${SLM_DIR}')
sys.path.insert(0, '$(dirname \"${SLM_DIR}\")/Documents/AGENTIC_Official/SuperLocalMemoryV2-repo/src')
try:
    from learning import get_learning_db
    ldb = get_learning_db()
    if ldb:
        ldb.reset()
        print('All learning data reset. Memories in memory.db preserved.')
    else:
        print('Learning database not available')
except ImportError:
    print('Learning features not available')
except Exception as e:
    print(f'Error: {e}')
"
                ;;
            *)
                echo "Usage: slm learning {status|retrain|reset}"
                exit 1
                ;;
        esac
        ;;

    engagement)
        python3 -c "
import sys
sys.path.insert(0, '${SLM_DIR}')
sys.path.insert(0, '$(dirname \"${SLM_DIR}\")/Documents/AGENTIC_Official/SuperLocalMemoryV2-repo/src')
try:
    from learning.engagement_tracker import EngagementTracker
    tracker = EngagementTracker()
    print(tracker.format_for_cli())
except ImportError:
    print('Learning features not available. Install: pip3 install lightgbm scipy')
except Exception as e:
    print(f'Error: {e}')
"
        ;;

    help|--help|-h)
        cat <<EOF
SuperLocalMemory V2 - Universal CLI

SIMPLE COMMANDS:
  slm remember <content>    Save to memory
  slm recall <query>        Search memories
  slm list [N]             List N recent memories (default 10)
  slm status               System status and statistics
  slm context              Project context for current directory

PROFILE MANAGEMENT:
  slm profile list         List all profiles
  slm profile create <name> Create new profile
  slm profile switch <name> Switch to profile
  slm profile delete <name> Delete profile
  slm profile current      Show current profile

KNOWLEDGE GRAPH:
  slm graph build          Build/rebuild knowledge graph
  slm graph stats          Show graph statistics

PATTERN LEARNING:
  slm patterns update      Learn patterns from memories
  slm patterns list [threshold]  List learned patterns
  slm patterns context [threshold]  Get coding identity context
  slm patterns correct <id> <value>  Correct a learned pattern

LEARNING (v2.7):
  slm useful <id> [id...]  Mark memories as useful (ranking feedback)
  slm learning status      Learning system status
  slm learning retrain     Force model retrain
  slm learning reset       Delete all learning data (memories preserved)
  slm engagement           Show engagement metrics

WEB DASHBOARD:
  slm ui [PORT]            Start web dashboard (default port 8765)
                           Opens at http://localhost:PORT

HTTP SERVER (MCP):
  slm serve [PORT]         Start MCP HTTP server (default port 8417)
                           For ChatGPT/remote: ngrok http PORT

ADVANCED:
  slm reset soft           Soft reset (clear memories)
  slm reset hard --confirm Hard reset (nuclear option)

ORIGINAL COMMANDS (still work):
  superlocalmemoryv2:remember <content>
  superlocalmemoryv2:recall <query>
  superlocalmemoryv2:list [N]
  superlocalmemoryv2:status
  superlocalmemoryv2:profile <command>
  superlocalmemoryv2:reset <type>

EXAMPLES:
  slm remember "Use FastAPI for REST APIs" --tags python,backend
  slm recall "FastAPI patterns" --limit 5
  slm context
  slm graph build
  slm patterns update
  slm status

DOCUMENTATION:
  README: https://github.com/varun369/SuperLocalMemoryV2
  Docs: ~/.claude-memory/docs/

VERSION: 2.7.0
EOF
        ;;

    version|--version|-v)
        echo "SuperLocalMemory V2 - Universal CLI"
        echo "Version: 2.7.0"
        echo "Database: $SLM_DIR/memory.db"
        ;;

    *)
        echo "SuperLocalMemory V2 - Universal CLI"
        echo ""
        echo "Usage: slm <command> [args]"
        echo ""
        echo "Commands:"
        echo "  remember  - Save to memory"
        echo "  recall    - Search memories"
        echo "  list      - List recent memories"
        echo "  status    - System status"
        echo "  context   - Project context"
        echo "  ui        - Start web dashboard"
        echo "  serve     - Start MCP HTTP server"
        echo "  profile   - Manage profiles"
        echo "  graph     - Knowledge graph operations"
        echo "  patterns  - Pattern learning"
        echo "  useful    - Mark memories as useful"
        echo "  learning  - Learning system management"
        echo "  engagement - Show engagement metrics"
        echo "  help      - Show detailed help"
        echo ""
        echo "Run 'slm help' for more information"
        exit 1
        ;;
esac
